image: python:3.10

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - venv/

stages:
  - build
  - test
  - lint
  - package

build:
  stage: build
  script:
    - pip install virtualenv
    - virtualenv venv/
    - source venv/bin/activate
    - pip install -r api/requirements.txt
    - cd api/sql
    - python3 create_tables.py
  rules:
    - changes:
      - api/*
  artifacts:
    paths:
      - api/api.db
    expire_in: 10 mins

test:
  stage: test
  before_script:
    - pip install virtualenv
    - virtualenv venv/
    - source venv/bin/activate
  script:
    - cd api/
    - pytest test*.py --junitxml=report.xml
  artifacts:
    when: always
    reports:
      junit: api/report.xml
  rules:
    - changes:
      - api/*

lint:
  stage: lint
  before_script:
    - pip install virtualenv
    - virtualenv venv/
    - source venv/bin/activate
  script:
    - pylint --fail-under 8.0 api/app.py
  rules:
    - changes:
      - api/*

package python files:
  stage: package
  image: alpine
  cache: []
  script:
    - apk --no-cache add zip
    - zip api/artifacts.zip api/*.py -x api/test*.py

  artifacts:
    paths:
      - api/artifacts.zip
  rules:
    - changes:
      - api/*